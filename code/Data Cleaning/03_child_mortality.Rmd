---
title: "03_child_mortality"
output: html_document
---

# Data Cleaning: Child Mortality Rates

## Load Libraries

```{r load_libs}
# Data manipulation
library(dplyr)
library(tidyr)
library(readr)
library(here)
library(purrr)
library(stringr)


# Extras for cleaning and exploration
library(janitor)  # clean column names
library(visdat)   # visualize missingness
library(skimr)    # summary stats
library(ggplot2)  # visualizations

```

## Load Dataset

```{r load_data}
# Load the child mortality dataset
cmr_df <- read_csv(
  here("data", "raw", "child-mortality-rates_national_zaf.csv"),
  col_types = cols()  # suppress column guessing warnings
)

# Remove first metadata row if present
cmr_df <- cmr_df[-1, ]
rownames(cmr_df) <- NULL

cat("Dataset loaded successfully.\n")
cat("Dimensions:", dim(cmr_df), "\n")



```

## Initial Data Assessment

```{r data_assessment }
# Clean column names
cmr_df <- janitor::clean_names(cmr_df)

# Peek at structure
glimpse(cmr_df)

# Summary stats
skim(cmr_df)

# Visualize missingness
vis_miss(cmr_df)

```

# Handle Duplicates

```{r}
cat("Exact duplicates:", sum(duplicated(cmr_df)), "\n")

cmr_df <- cmr_df %>% distinct()

cat("Dimensions after deduplication:", dim(cmr_df), "\n")


```

## Drop Redundant / Empty Columns

```{r redundant_empty_columns}
redundant_cols <- c("iso3", "data_id", "dhs_country_code", "country_name", "survey_id",
                    "indicator_id", "sdrid", "region_id", "survey_type", "level_rank",
                    "denominator_weighted", "denominator_unweighted", "by_variable_label")

# Remove safely
cmr_df <- cmr_df %>% select(-any_of(redundant_cols))


cat("Dimensions after removing redundant/empty columns:", dim(cmr_df), "\n")


```

## Convert Column Types

-   Ensure numeric, integer, and logical columns are typed correctly for analysis.

```{r convert_column_types}
# Convert columns to appropriate types
# Define expected columns by type
# If you use janitor::clean_names(), use lowercase names
numeric_cols <- c("value", "precision", "ci_low", "ci_high")
integer_cols <- c("survey_year", "indicator_order", "characteristic_id",
                  "characteristic_order", "survey_year_label")
logical_cols <- c("is_total", "is_preferred")


# Standardize column names to match R-safe format
colnames(cmr_df) <- str_replace_all(colnames(cmr_df), "\\s+", "_")
colnames(cmr_df) <- str_to_title(colnames(cmr_df)) # optional for uniformity

# Function to safely convert columns if they exist
safe_convert <- function(df, cols, fun) {
  existing <- cols[cols %in% colnames(df)]
  if(length(existing) > 0) {
    df <- df %>% mutate(across(all_of(existing), fun))
  }
  return(df)
}

# Apply conversions
cmr_df <- cmr_df %>%
  safe_convert(numeric_cols, as.numeric) %>%
  safe_convert(integer_cols, as.integer) %>%
  safe_convert(logical_cols, ~as.logical(as.integer(.)))

# Check final types
glimpse(cmr_df)
```

## Handle Missing Values

```{r handle_missing_values}
# Function to get mode
impute_mode <- function(x){
  ux <- na.omit(x)
  if(length(ux)==0) return(x)
  rep(names(sort(table(ux), decreasing=TRUE))[1], length(x))
}

cmr_df <- cmr_df %>%
  mutate(across(where(is.numeric), ~ifelse(is.na(.), median(., na.rm=TRUE), .))) %>%
  mutate(across(where(is.character), ~ifelse(is.na(.), impute_mode(.), .)))

cat("Remaining NAs:", sum(is.na(cmr_df)), "\n")

```

## Handle Outliers

```{r Outliers}
num_cols <- cmr_df %>% select(where(is.numeric))

outlier_bounds <- function(x) {
  qnt <- quantile(x, probs=c(0.25, 0.75), na.rm=TRUE)
  iqr <- diff(qnt)
  c(lower=qnt[1]-1.5*iqr, upper=qnt[2]+1.5*iqr)
}

bounds <- map(num_cols, outlier_bounds)

cmr_df <- cmr_df %>%
  mutate(across(where(is.numeric),
                ~pmin(pmax(., bounds[[cur_column()]]["lower"]),
                      bounds[[cur_column()]]["upper"])))

```

## Handle Noise / Special Values

```{r}
cmr_df <- cmr_df %>%
  mutate(across(where(is.numeric),
                ~ifelse(. < 0, median(., na.rm = TRUE), .)))

```

## Final Validation

```{r}
cat("=== FINAL CLEANED DATA ===\n")
cat("Dimensions:", dim(cmr_df), "\n")
skim(cmr_df)

```

## Save the Cleaned Dataset

```{r save dataset}
# Save cleaned dataset to processed folder
write_csv(cmr_df, here("data", "processed", "child-mortality-rates_cleaned.csv"))

cat("Cleaned dataset saved successfully.\n")
cat("Dimensions:", dim(cmr_df), "\n")

```

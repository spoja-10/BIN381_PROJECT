---
title: "10_Maternal_mortality"
output:
  word_document: default
  html_document: default
---

#Loading Libraries
```{r}
library(dplyr)
library(tidyr)
library(stringr)
library(readr)
library(here)
library(purrr)


```
#Load Dataset 
```{r}
mam_df <- read_csv(here("data","raw", "maternal-mortality_national_zaf.csv"))
```

#Disdplay Dataset content
```{r}
head(mam_df)
```

#Remove the first row(meta data)
```{r}
mam_df <- mam_df[-1, ]
```
#dimensions 
```{r}
dim(mam_df)
```

#Inspect Duplicated rows
```{r}
dup_check <- mam_df %>%
  group_by(Indicator, SurveyYear, CharacteristicId, Value) %>%
  filter(n() > 1)

dup_check

```

#perc mising values
```{r}

data.frame(
  Column = names(mam_df),
  Missing_Percentage = paste0(round(colMeans(is.na(mam_df)) * 100, 2), "%")
  )

```

```{r}
mam_df <- mam_df %>%
  select(-RegionId, -LevelRank, -CILow, -CIHigh)  # 100% or 85% missing

# 2. Impute numeric columns with missing values
# Here, only DenominatorWeighted and DenominatorUnweighted
num_cols <- c("DenominatorWeighted", "DenominatorUnweighted")

mam_df <- mam_df %>%
  mutate(across(all_of(num_cols), ~ ifelse(is.na(.), median(., na.rm = TRUE), .)))

# 3. Fill any remaining missing values using last observation carried forward/backward
mam_df <- mam_df %>%
  fill(DenominatorWeighted, DenominatorUnweighted, .direction = "downup")

# 4. Check that missing values are gone
data.frame(
  Column = names(mam_df),
  Missing_Data = colSums(is.na(mam_df))
)
```

#check data types
```{r}
data.frame(
  Column = names(mam_df),
  paste0(sapply(mam_df, typeof))
)

```
#Check The structure of the dataset 
```{r}
str(mam_df)

```

#Convert Data Types
```{r}
mam_df <- mam_df %>%
  mutate(
        Value = as.numeric(Value),
    Precision = as.numeric(Precision),
    SurveyYear = as.integer(SurveyYear),
    IndicatorOrder = as.integer(IndicatorOrder),
    CharacteristicId = as.integer(CharacteristicId),
    CharacteristicOrder = as.integer(CharacteristicOrder),
    IsTotal = as.logical(as.integer(IsTotal)),
    IsPreferred = as.logical(as.integer(IsPreferred)),
    SurveyYearLabel = as.integer(SurveyYearLabel),
    DenominatorWeighted = as.numeric(DenominatorWeighted),
    DenominatorUnweighted = as.numeric(DenominatorUnweighted),
  )
```
# Summary table: column name, number of unique values, sample of unique values
```{r}

n_sample <- 3

summary_tbl <- mam_df %>%
  map_df(~ tibble(
    n_unique = n_distinct(.),
    sample_values = paste(head(unique(.), n_sample), collapse = ", ")
  ), .id = "column")

summary_tbl
```
  

# Drop the countries only one unqiue value: reason, there is no useful information - county is also always za
```{r}
# See exact column names
colnames(mam_df)

# Then drop using safe selection
cols_to_drop <- c("iso3", "dhs_country_code", "country_name", "survey_id",
                  "by_variable_id", "by_variable_label", "is_total",
                  "region_id", "survey_year_label", "survey_type", "characteristic_order")

# Only drop columns that exist
mam_df <- mam_df %>% select(-any_of(cols_to_drop))

# Confirm
colnames(mam_df)

```

# Outliers
```{r}


# Statistical outlier detection
outlier_stats <- mam_df %>%
  summarise(
    mean_value = mean(Value, na.rm = TRUE),
    sd_value = sd(Value, na.rm = TRUE),
    outliers_upper = sum(Value > mean_value + 2*sd_value, na.rm = TRUE),
    outliers_lower = sum(Value < mean_value - 2*sd_value, na.rm = TRUE)
  )



print(outlier_stats)




```

- The data set does not have any outliers so no need to handle


#save cleaned data
```{r}
write_csv(mam_df, here("data","processed", "maternal-mortality_cleaned.csv"))
```
